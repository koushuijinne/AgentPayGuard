# .clinerules - Agent 工作约束

## ⚠️ 强制提醒（每次工作前必读）

1. ✅ 完整阅读本文件
2. ✅ 确认理解所有约束
3. ✅ **特别：禁止读取 `.env*` 文件**
4. ✅ 使用文末自检清单

---

## 安全约束

### 1. 禁止读取敏感文件
- ✗ 拒绝读取任何 `.env*`（含 `.env.local` 等）
- ✗ 拒绝读取含私钥/API 密钥的文件
- 基于**文件名黑名单**，不依赖用户提醒

### 2. 不修改安全政策
- ✗ 不删除本约束文件（除非用户明确要求）
- 每个 commit 前检查是否被意外修改

### 3. 代码提交前必须验证
- ✗ 不提交未通过 `pnpm typecheck` 的代码
- ✗ 不提交未通过 `pnpm demo:pay` 和 `pnpm demo:reject` 的代码

---

## 工作流约束

### 4. 实时更新工作日志
- ✓ 每个 Phase 完成后立即更新 `AGENT_WORKLOG.md`（背景、步骤、文件变更、验证）
- ✓ 每次 commit 有对应日志条目
- ✗ 不说"等合适时机再更新"

### 4b. Worklog 自动精简
- ✓ `AGENT_WORKLOG.md` 达 1000 行时，自动精简到 500 行内
- 保留：Phase 摘要表、当前状态、运行命令、关键文件、附录
- 精简：各 Phase 描述压缩为 2–4 行要点

### 5. 清晰的 Git 提交
- ✓ commit 含 Phase 号 + 操作描述（例：`Phase 12: Create TESTING_GUIDE.md`）
- ✓ 一个 commit 一个完整功能
- ✗ 不用 "WIP"、"temp" 等模糊信息

### 5b. 每次修改后自动 push
- ✓ commit 完成后立即 `git push`
- ✗ 不得只 commit 不 push（除非网络不可用或用户要求暂不推送）

### 6. 任务追踪
- ✓ 多步骤工作（3+ 步）使用 todo 工具，显式标记状态
- ✗ 不能同时标记多个 TODO 为 in-progress

---

## 代码质量约束

### 7. TypeScript 严格模式
- ✓ 所有 `.ts` 通过 `pnpm typecheck`（0 errors）
- ✗ 不用 `any`（除非别无选择并注释说明）

### 8. Demo 脚本必须工作
- ✓ `pnpm demo:pay`、`pnpm demo:reject` 必须正常
- ✗ 修改代码后必须重新验证

### 9. 不破坏现有功能
- ✓ 重构时保证已通过测试仍通过
- ✗ 不能为简化某部分而删除其他工作功能

---

## 决策约束

### 10. 重要决定需确认
- ✓ 架构变更、大重构、删除代码前询问用户
- ✗ 不武断决定关键方向

### 11. 文档控制
- ✓ 创建新文档前询问是否真正需要
- ✓ 文档简洁、单一目的、易维护
- ✗ 不创建冗余或一次性文档

### 12. 设计决策文档化
- ✓ 非平凡技术决策记录在适当文件中
- ✗ 不能只在对话中说明

---

## 项目结构约束

### 13. 不移动或删除核心文件
- ✗ 不删除 `src/lib/kite-aa.ts`、`policy.ts` 等
- ✗ 不随意迁移核心逻辑路径
- ✓ 重组前先更新 `allocation.md`

### 14. 环境变量范式
- ✓ 所有配置有 `.env.example` 条目
- ✗ 不引入未在模板中记录的新环境变量
- ✓ 修改 `.env.example` 后更新 TESTING_GUIDE

---

## 交流约束

### 15. 清晰的进度反馈
- ✓ 复杂任务完成后总结：已完成、待处理、有依赖
- ✗ 不给出模糊的"差不多了"

### 16. 链接文件用 Markdown
- ✓ 用 `[文件名](路径)` 格式
- ✗ 不用反引号包装文件名

---

## 例外处理

仅在以下情况可请求修改约束：① 用户明确要求；② 约束导致严重阻碍且无替代；③ 约束含安全漏洞。流程：Agent 提议 → 用户批准 → 更新约束 → commit 说明原因。

---

## 安全政策（Security Policy）

### 禁止共享敏感信息
- ✗ 提交 `.env` 到 Git；向 AI 或外部工具提供 `.env` 内容
- ✗ 在讨论、文档、日志、截图中暴露私钥、API Key、RPC 密钥
- 敏感信息：`PRIVATE_KEY`、`MNEMONIC`、`API_KEY`、`.env*`

### 安全做法
- ✓ `.env` 在 `.gitignore`；`chmod 600 .env`
- ✓ 用 `.env.example` 作公开模板（占位符替代真实值）
- ✓ 与 AI 交互：只讨论 `.env.example`、用占位符描述

### AI Assistant 规则
- **永不读取** `.env*` 文件（文件名黑名单）
- **自动拒绝** 对敏感文件的读取请求
- **不存储** 私钥或密钥

### 泄露时
1. 立即停用该密钥（转移资金 / 轮换 API Key）
2. 从 Git 历史移除（git-filter-branch 或 BFG）
3. 通知团队；更新本文件记录

**所有团队成员应阅读并遵守。** 如有安全问题立即上报。

---

## 自检清单

- [ ] AGENT_WORKLOG 已更新
- [ ] `pnpm typecheck` 0 errors
- [ ] `pnpm demo:pay`、`pnpm demo:reject` 正常
- [ ] 未新增/修改 `.env*`
- [ ] commit message 清晰
- [ ] 本文件未被意外修改
- [ ] 重要决定已文档化
